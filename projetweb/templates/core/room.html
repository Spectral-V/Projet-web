<!DOCTYPE html>
{% load static %}
<html lang="fr">


<head>
    <meta charset="utf-8" />
    <title>Pasteque | The ultimate chat</title>
    <link rel="icon" href="media/media/icon.png" sizes="32x32" type="image/png"/>
    <link rel="stylesheet" href="{% static 'core/styles.css' %}" />
    <script   src="https://code.jquery.com/jquery-3.1.1.min.js"   integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="   crossorigin="anonymous"></script>
    
    
</head>
    <body>
            <header>
                <div class="header-div">
                    <a href=""><img width="200" height="75" src="{% static 'img/logo.png' %}" /> </a>
                    <a href="settings" class="sett"><img width="40" height="40" src="{% static 'img/setting.png' %}"/> </a>
                </div>
            </header>
            <section>
                <div class="title">
                    <h2> {{ room.name }} - TAG : {{ room.room_id }} </h2>
                </div>
                <div class="left-panel">
                    <div class="select-room">
                        <form action="" method="POST">
                            {% csrf_token %}
                            <input type="hidden" name="form-type" value="jroom" />
                            <input type="text" name="roomid" class="form-tag" placeholder="Tag du Salon" />
                            <div class="info-in">
                                {% for e in alers %}
                                    <h5>{{e}}</h5>
                                {% endfor %}
                            </div>
                            <button type="submit" class="btn-7"> I join a room </button>
                        </form>
                    </div>
                    <div class="select-room">
                        <form action="" method="POST">
                            {% csrf_token %}
                            <input type="hidden" name="form-type" value="croom" />
                            <input type="text" name="roomname" class="form-tag" placeholder="Nom du salon" />
                            <button type="submit" class="btn-7"> I create a room </button>
                        </form>
                    </div>
                    <div class="logout">
                        <form action="" method="POST">
                            {% csrf_token %}
                            <input type="hidden" name="form-type" value="logout" />
                            <button type="submit" class="btn-7"> I log out </button>
                            {% if perm.level == "owner"  %}
                                                <a>room open :</a>
                                                <input  type="checkbox" value="YES" id="open" name="lopen" onclick="openandclose({{room.room_id}})" {% if room.open == "yes" %} checked {% endif %} >
                             {% endif %}
                        </form>
                    </div>
                    
                </div>
                <div class="msg-display">
                    <div class="msg" id="display">
                    </div>
                    <form action="" method="POST">
                        {% csrf_token %}
                        <input type="hidden" name="form-type" value="msg" />
                        <input type="text" name="message" class="msg-write" placeholder="Tapez votre message" />
                        <button type="submit" class="btn-6"> Send a text </button>
                    </form>
                </div>
                <div class="member">
                    <h3> Members : </h3>
                    {% for p in permr %}
                            {% if p.level == "owner" %}
                                <h4> Owner : </h4>
                                <div class="upp"> <img width="25" height="25" src="{{p.user.profileimg.url}}" class="userimg"></div>
                                <div class="user"> {{p.user}} </div>
                            {% endif %}
                    {% endfor %}
                    <h4> Users: </h4>
                    {% for p in permr %}
                            {% if p.level == "admin" %}
                                <div class="upp"> <img width="25" height="25" src="{{p.user.profileimg.url}}" class="userimg"></div>
                                 <div class="user"> {{p.user}} </div>
                                 {% if perm.level == "owner" %}
                                 <div class='block-button'>
                                    <button id="btn-s" class="btn-9" onclick="mute({{p.user.id_user}},{{p.room.room_id}})"> <img src="{% static 'img/mute.png' %}" width='10' height='10' alt='submit' /></button>
                                </div>
                                <div class='block-button'>
                                    <button id="btn-s" class="btn-9" onclick="ban({{p.user.id_user}},{{p.room.room_id}})"> <img src="{% static 'img/ban.png' %}" width='10' height='10' alt='submit' /> </button>
                                </div>
                                <div class='block-button'>
                                    <button id="btn-s" class="btn-9" onclick="admin({{p.user.id_user}},{{p.room.room_id}})"> <img src="{% static 'img/up.png' %}" width='10' height='10' alt='submit' /> </button>  
                                </div>
                                {% endif %}
                            {% endif %}
                    {% endfor %}
                    {% for p in permr %}
                            {% if p.level == "normal" %}
                                <div class="upp"> <img width="25" height="25" src="{{p.user.profileimg.url}}" class="userimg"></div>
                                <div class="user"> {{p.user}} </div>
                                {% if perm.level == "owner" or perm.level == "admin" %}
                                    <div class='block-button'>
                                            <button id="btn-s" class="btn-9" onclick="mute({{p.user.id_user}},{{p.room.room_id}})"> <img src="{% static 'img/mute.png' %}" width='10' height='10' alt='submit' /></button>
                                    <div class='block-button'>
                                            <button id="btn-s" class="btn-9" onclick="ban({{p.user.id_user}},{{p.room.room_id}})"> <img src="{% static 'img/ban.png' %}" width='10' height='10' alt='submit' /> </button>
                                    <div class='block-button'>
                                            <button id="btn-s" class="btn-9" onclick="admin({{p.user.id_user}},{{p.room.room_id}})"> <img src="{% static 'img/up.png' %}" width='10' height='10' alt='submit' /> </button>
                                        
                                {% endif %}
                            {% endif %}
                    {% endfor %}
                </div>
            </section>
            <footer>
                <p>Create by Victor Murris and RÃ©mi and Routier and Matthis Lahargoue &#169</p>
            </footer>
    </body> 
    <script> 
        function openandclose(rid) {
            var a = "/openandclose/"+rid+"";
            $.ajax({
                type: 'GET',
                url : a,
                success: function(data){
                
                },
                error: function(data){
                  
                }
            });
        }
    

        function admin(uid,rid) {
            var a = "/adm/"+uid+"/"+rid+"";
            $.ajax({
                type: 'GET',
                url : a,
                success: function(data){
                    console.log(data) 
                },
                error: function(data){
                }
            });
            
        }
        function ban(uid,rid) {
            var a = "/ban/"+uid+"/"+rid+"";
            $.ajax({
                type: 'GET',
                url : a,
                success: function(data){
                    console.log(data) 
                },
                error: function(data){ 
                }
            });
            
        }
        function mute(uid,rid) {
            var a = "/mute/"+uid+"/"+rid+"";
            $.ajax({
                type: 'GET',
                url : a,
                success: function(data){
                    console.log(data) 
                },
                error: function(data){
                }
            });
            
        }

        function delmess(id) {
            
            var b = "/deletemessage/"+id+"";
            $.ajax({
                type: 'GET',
                url : b,
                success: function(data){ 
                    console.log(data)   
                },
                error: function(data){
                }
            });
            
        }
        function display_data () {
            $.ajax({
                type: 'GET',
                url : "/getMessages/{{room.room_id}}/",
                success: function(response){
    
                    console.log(response);
                    $("#display").empty();
                    for (let i = 1; i <= response.mess.length; i++)
                    {
                        var temp="<div class='msg-sender'>"+response.mess[i-1].sender+"</div><div class='msg-time'>"+response.mess[i-1].date+"</div> <div class='block-button'>{% if perm.level == 'owner' %}  <button id='btn-s' class='btn-8' onclick='delmess("+response.mess[i-1].id+")'> <img src='{% static 'img/trash.png' %}' width='10' height='10' alt='submit' /> </button>  {% endif %} </div> <div class='block-button'>{% if perm.level == 'owner' %}  <button id='btn-s' class='btn-8' onclick='ban("+response.mess[i-1].senderid+","+response.mess[i-1].roomid+")'> <img src='{% static 'img/ban.png' %}' width='10' height='10' alt='submit' /> </button>  {% endif %} </div> <div class='block-button'>{% if perm.level == 'owner' %}  <button class='btn-8' onclick='mute("+response.mess[i-1].senderid+","+response.mess[i-1].roomid+")'> <img src='{% static 'img/mute.png' %}' width='10' height='10' alt='submit' /> </button>  {% endif %} </div>  <div class='block-button'>{% if perm.level == 'owner' %}  <button class='btn-8' onclick='admin("+response.mess[i-1].senderid+","+response.mess[i-1].roomid+")'> <img src='{% static 'img/up.png' %}' width='10' height='10' alt='admin' title='admin'/> </button>  {% endif %} </div> <div class='msg-text'>"+response.mess[i-1].message+"</div>";
                        $("#display").append(temp);
                        $("#display").scrollTop($("#display")[0].scrollHeight);
                        
                        
                    }
                    
                    
                    
                },
                error: function(response){
                    alert('An error occured')
        
                   
                }
            });
            setInterval(function(){
                $.ajax({
                    type: 'GET',
                    url : "/getMessages/{{room.room_id}}/",
                    success: function(response){
        
                        console.log(response);
                        $("#display").empty();
                        for (let i = 1; i <= response.mess.length; i++)
                        {
                            var temp="<div class='msg-sender'>"+response.mess[i-1].sender+"</div><div class='msg-time'>"+response.mess[i-1].date+"</div> <div class='block-button'>{% if perm.level == 'owner' %}  <button id='btn-s' class='btn-8' onclick='delmess("+response.mess[i-1].id+")'> <img src='{% static 'img/trash.png' %}' width='10' height='10' alt='submit' /> </button>  {% endif %} </div> <div class='block-button'>{% if perm.level == 'owner' %}  <button id='btn-s' class='btn-8' onclick='ban("+response.mess[i-1].senderid+","+response.mess[i-1].roomid+")'> <img src='{% static 'img/ban.png' %}' width='10' height='10' alt='submit' /> </button>  {% endif %} </div> <div class='block-button'>{% if perm.level == 'owner' %}  <button class='btn-8' onclick='mute("+response.mess[i-1].senderid+","+response.mess[i-1].roomid+")'> <img src='{% static 'img/mute.png' %}' width='10' height='10' alt='submit' /> </button>  {% endif %} </div>  <div class='block-button'>{% if perm.level == 'owner' %}  <button class='btn-8' onclick='admin("+response.mess[i-1].senderid+","+response.mess[i-1].roomid+")'> <img src='{% static 'img/up.png' %}' width='10' height='10' alt='admin' title='admin'/> </button>  {% endif %} </div> <div class='msg-text'>"+response.mess[i-1].message+"</div>";
                            $("#display").append(temp);
                            
                            
                        }
                        
                        
                        
                    },
                    error: function(response){
                        alert('An error occured')
            
                       
                    }
                });
            
            
            },1000);
        
        }
        $(document).ready(function(){
            display_data()
            
            
        })
        
    </script>
</html> 
